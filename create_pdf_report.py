import pandas as pd
import matplotlib.pyplot as plt
import networkx as nx
from fpdf import FPDF

# Load the CSV file
df = pd.read_csv('/home/slanycukr/Downloads/ordered_api_calls_by_timestamp.csv')

# Preprocess and filter the DataFrame
df['total_calls'] = df['ordered_api_calls'].apply(lambda x: len(x.split(' -> ')) if isinstance(x, str) else 0)
filtered_reports = df[(df['total_calls'] >= 100) & (df['total_calls'] <= 150)].head(20)


class PDF(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 12)
        self.cell(0, 10, 'API Call Analysis Report', 0, 1, 'C')

    def add_report_section(self, title, api_calls_str, filename):
        self.add_page()
        self.set_font('Arial', 'B', 12)
        self.cell(0, 10, title, 0, 1, 'L')
        self.set_font('Arial', '', 10)

        G = nx.DiGraph()
        api_calls = api_calls_str.split(' -> ')
        for i in range(len(api_calls) - 1):
            G.add_edge(api_calls[i], api_calls[i + 1])

        plt.figure(figsize=(12, 8))
        pos = nx.circular_layout(G)
        nx.draw(G, pos, with_labels=True, node_color='lightblue', edge_color='gray', node_size=1500, font_size=8,
                arrows=True)
        if api_calls:
            nx.draw_networkx_nodes(G, pos, nodelist=[api_calls[0]], node_color='green')
            nx.draw_networkx_nodes(G, pos, nodelist=[api_calls[-1]], node_color='red')
        graph_path = f'/tmp/api_call_graph_{filename}.png'
        plt.savefig(graph_path)
        plt.close()

        self.image(graph_path, x=10, w=180)

        # Add a table for API call counts
        api_call_counts = pd.Series(api_calls).value_counts().sort_values(ascending=False)
        self.set_fill_color(200, 220, 255)  # Light blue background for header
        self.set_font('Arial', 'B', 10)
        self.cell(90, 10, 'API Call', 1, 0, 'C', 1)
        self.cell(40, 10, 'Count', 1, 1, 'C', 1)
        self.set_font('Arial', '', 10)
        for api, count in api_call_counts.items():
            self.cell(90, 10, api, 1)
            self.cell(40, 10, str(count), 1, 1)


pdf = PDF()
for index, row in filtered_reports.iterrows():
    report_title = f'Report {index + 1}: {row["filename"]}'
    pdf.add_report_section(report_title, row['ordered_api_calls'], row['filename'])

pdf.output('API_Call_Analysis_Report.pdf')
