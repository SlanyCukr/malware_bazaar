import os
import json
import pandas as pd

def analyze_api_calls(directory):
    data = []

    for filename in os.listdir(directory):
        if filename.endswith('.json'):
            file_path = os.path.join(directory, filename)
            api_calls_with_timestamp = []

            with open(file_path, 'r') as file:
                json_data = json.load(file)
                processes = json_data.get('behavior', {}).get('processes', [])
                
                for process in processes:
                    for call in process.get('calls', []):
                        timestamp = call.get('timestamp')
                        api = call.get('api')
                        if api and timestamp:
                            api_calls_with_timestamp.append((timestamp, api))

            # Sorting by timestamp
            api_calls_with_timestamp.sort(key=lambda x: x[0])
            ordered_api_calls = ' -> '.join([api for _, api in api_calls_with_timestamp])
            data.append({'filename': filename, 'ordered_api_calls': ordered_api_calls})

    return pd.DataFrame(data)

# Replace with the actual path to your reports directory
directory_path = '/home/cape/malware_bazaar/reports'
df = analyze_api_calls(directory_path)

# Display the first few rows of the dataframe
print(df.head())

# Optional: Save the dataframe to a CSV file
df.to_csv('/home/cape/malware_bazaar/ordered_api_calls_by_timestamp.csv', index=False)
